{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Campus Connect | Admin Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f7fbf8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border: rgba(15,23,42,0.10);

      --green:#16a34a;
      --green2:#22c55e;

      --shadow2: 0 10px 28px rgba(15,23,42,0.08);
      --radius: 18px;
    }

    body{
      min-height:100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 450px at 15% 10%, rgba(34,197,94,0.16), transparent 55%),
        linear-gradient(120deg, #ffffff 0%, var(--bg) 65%, #ffffff 100%);
    }

    .cc-nav{
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }
    .brand{
      text-decoration:none;
      color: var(--text);
      font-weight: 900;
      letter-spacing: -0.02em;
      display:flex;
      align-items:center;
      gap:.75rem;
    }
    .brand-badge{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--green), var(--green2));
      display:flex;
      align-items:center;
      justify-content:center;
      color: #06120a;
      font-weight: 950;
      box-shadow: 0 14px 30px rgba(34,197,94,0.22);
    }

    .btn-pill{
      border-radius: 999px;
      padding: .55rem 1.1rem;
      font-weight: 800;
    }
    .btn-ghost{
      border: 1px solid rgba(15,23,42,0.18);
      background: #fff;
      color: var(--text);
    }
    .btn-ghost:hover{ background:#f8fafc; }

    .wrap{ padding: 2rem 0 3rem; }

    .cc-card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
    }
    .cc-card-pad{ padding: 1.25rem; }

    .title{
      font-weight: 950;
      letter-spacing: -0.02em;
      margin-bottom: .25rem;
    }
    .sub{ color: var(--muted); font-weight: 600; }

    .stat-label{ color: var(--muted); font-weight: 800; font-size: .92rem; }
    .stat-value{ font-weight: 950; font-size: 1.7rem; letter-spacing: -0.02em; }

    .table thead th{
      color: var(--muted);
      font-weight: 900;
      font-size: .9rem;
      border-bottom-color: rgba(15,23,42,0.10);
    }
    .table td{
      vertical-align: middle;
      border-top-color: rgba(15,23,42,0.08);
      font-weight: 600;
    }

    .role-pill{
      border-radius: 999px;
      padding: .28rem .65rem;
      font-weight: 900;
      font-size: .85rem;
      border: 1px solid rgba(15,23,42,0.12);
      color: var(--muted);
      background: #fff;
      display:inline-block;
    }

    .btn-approve{
      border: 0;
      border-radius: 999px;
      padding: .45rem .9rem;
      font-weight: 900;
      color: #06120a;
      background: linear-gradient(135deg, var(--green), var(--green2));
    }
    .btn-reject{
      border-radius: 999px;
      padding: .45rem .9rem;
      font-weight: 900;
      border: 1px solid rgba(15,23,42,0.18);
      background: #fff;
      color: var(--text);
    }

    .mini-link{
      font-weight: 900;
      text-decoration:none;
      color: var(--green);
    }
    .mini-link:hover{ text-decoration:underline; }

    footer{
      color: var(--muted);
      font-weight: 600;
      font-size: .9rem;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(15,23,42,0.10);
      margin-top: 2rem;
    }
  </style>
</head>

<body>
  <nav class="cc-nav py-3">
    <div class="container d-flex align-items-center justify-content-between gap-3">
      <a class="brand" href="{% url 'core:landing' %}">
        <span class="brand-badge">CC</span>
        <span>Campus Connect</span>
      </a>

      <div class="d-flex align-items-center gap-2">
        <div class="d-none d-md-block small" style="color:var(--muted); font-weight:700;">
          Admin: <span style="color:var(--text); font-weight:900;">{{ request.user.username }}</span>
        </div>
        <a class="btn btn-pill btn-ghost" href="{% url 'accounts:logout' %}">Logout</a>
      </div>
    </div>
  </nav>

  <main class="wrap">
    <div class="container">

      {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
        <div>
          <h2 class="title">Admin Dashboard</h2>
          <div class="sub">Approve Student/Staff accounts and oversee system modules.</div>
        </div>

        <div class="d-flex gap-2 flex-wrap">
          <a class="btn btn-pill btn-ghost" href="/admin/">Open Django Admin</a>
          <a class="btn btn-pill btn-ghost" href="{% url 'notices:list' %}">Notices</a>
          <a class="btn btn-pill btn-ghost" href="{% url 'events:list' %}">Events</a>
          <a class="btn btn-pill btn-ghost" href="{% url 'payments:staff_list' %}?status=pending">Payments</a>
          <a class="btn btn-pill btn-ghost" href="{% url 'lostfound:staff_claims' %}?status=pending">Claims</a>
          <a class="btn btn-pill btn-ghost" href="{% url 'accounts:admin_users' %}">Manage Users</a>
        </div>
      </div>

      <!-- Main Stats -->
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <div class="cc-card cc-card-pad">
            <div class="stat-label">Total Students (Active)</div>
            <div class="stat-value">{{ stats.students_total }}</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="cc-card cc-card-pad">
            <div class="stat-label">Total Staff (Active)</div>
            <div class="stat-value">{{ stats.staff_total }}</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="cc-card cc-card-pad">
            <div class="stat-label">Pending Approvals</div>
            <div class="stat-value">{{ stats.pending_total }}</div>
          </div>
        </div>
      </div>

      <!-- Module Overview Stats -->
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="cc-card cc-card-pad">
            <div class="stat-label">Events (Total)</div>
            <div class="stat-value">{{ stats.events_total|default:0 }}</div>
            <div class="small mt-1" style="color:var(--muted); font-weight:700;">
              <a class="mini-link" href="{% url 'events:list' %}">Open events</a>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="cc-card cc-card-pad">
            <div class="stat-label">Registrations (Total)</div>
            <div class="stat-value">{{ stats.registrations_total|default:0 }}</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="cc-card cc-card-pad">
            <div class="stat-label">Notices (Active)</div>
            <div class="stat-value">{{ stats.notices_total|default:0 }}</div>
            <div class="small mt-1" style="color:var(--muted); font-weight:700;">
              <a class="mini-link" href="{% url 'notices:create' %}">+ Create notice</a>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="cc-card cc-card-pad">
            <div class="stat-label">Payments Pending</div>
            <div class="stat-value">{{ stats.pending_payments|default:0 }}</div>
            <div class="small mt-1" style="color:var(--muted); font-weight:700;">
              <a class="mini-link" href="{% url 'payments:staff_list' %}?status=pending">Review payments</a>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="cc-card cc-card-pad">
            <div class="stat-label">Lost &amp; Found Claims Pending</div>
            <div class="stat-value">{{ stats.pending_claims|default:0 }}</div>
            <div class="small mt-1" style="color:var(--muted); font-weight:700;">
              <a class="mini-link" href="{% url 'lostfound:staff_claims' %}?status=pending">Review claims</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Pending table -->
      <div class="cc-card">
        <div class="cc-card-pad d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
          <div style="font-weight:950; letter-spacing:-0.01em;">Pending User Approvals</div>
          <div class="small" style="color:var(--muted); font-weight:700;">
            Only Student/Staff accounts appear here.
          </div>
        </div>

        <div class="table-responsive px-3 pb-3">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Joined</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>

            <tbody>
              {% for u in pending_users %}
                <tr>
                  <td>{{ u.username }}</td>
                  <td>{{ u.email|default:"â€”" }}</td>
                  <td><span class="role-pill">{{ u.role }}</span></td>
                  <td>{{ u.date_joined|date:"M d, Y" }}</td>

                  <td class="text-end">
                    <div class="d-flex justify-content-end align-items-center gap-2 flex-wrap">

                      <!-- Approve -->
                      <form method="post" action="{% url 'accounts:admin_approve_user' u.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-approve">Approve</button>
                      </form>

                      <!-- Reject (deactivate) -->
                      <form method="post" action="{% url 'accounts:admin_reject_user' u.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-reject"
                          onclick="return confirm('Deactivate this account?')">
                          Reject
                        </button>
                      </form>

                      <!-- Change Role -->
                      <form method="post" action="{% url 'accounts:admin_change_role' u.id %}" class="d-inline">
                        {% csrf_token %}
                        <div class="d-flex align-items-center gap-2">
                          <select name="role" class="form-select form-select-sm" style="width:auto;">
                            <option value="STUDENT" {% if u.role == "STUDENT" %}selected{% endif %}>Student</option>
                            <option value="STAFF" {% if u.role == "STAFF" %}selected{% endif %}>Staff</option>
                            <option value="ADMIN" {% if u.role == "ADMIN" %}selected{% endif %}>Admin</option>
                          </select>
                          <button type="submit" class="btn btn-outline-dark btn-sm btn-pill">Update</button>
                        </div>
                      </form>

                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="text-center py-4" style="color:var(--muted); font-weight:700;">
                    No pending approvals ðŸŽ‰
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <footer class="text-center">
        Â© {{ year|default:"2026" }} Campus Connect. All rights reserved.
      </footer>
    </div>
  </main>
</body>
</html>
